name: Poll UI and deploy if changed

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  poll_build_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout host (with submodule)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SUBMODULE_PAT }}
          submodules: recursive

      - name: Fetch latest UI main SHA
        id: ui
        run: |
          cd mobile-ui-module
          git fetch origin main
          echo "sha=$(git rev-parse origin/main)" >> $GITHUB_OUTPUT
          cd ..

      - name: Compare to last deployed SHA
        id: cache
        uses: actions/cache@v4
        with:
          path: .last-ui-sha
          key: ui-sha-${{ steps.ui.outputs.sha }}

      - name: Stop if no change
        if: steps.cache.outputs.cache-hit == 'true'
        run: echo "No UI change, skipping deploy."

      - name: Save SHA
        if: steps.cache.outputs.cache-hit != 'true'
        run: echo "${{ steps.ui.outputs.sha }}" > .last-ui-sha

      - name: Setup Node.js
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0
          cache: npm

      - name: Run Sync Script
        if: steps.cache.outputs.cache-hit != 'true'
        run: node ./scripts/mobile-ui.mjs

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd mobile-ui-module
          npm i

      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm run build

      - name: Deploy to Azure Static Web Apps
        if: steps.cache.outputs.cache-hit != 'true'
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_KIND_ROCK_01B2FB803 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "mobile-ui-module/dist"
          api_location: ""
          skip_app_build: true
          skip_api_build: true
